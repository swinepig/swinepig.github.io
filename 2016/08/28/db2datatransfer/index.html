<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><meta name="google-site-verification" content="6GTeiOhqimfTtuUIQtS8CqdXJzM4lPPMeXjbvNAsm5w"><title>记一次数据迁移的经历 | Swinepig</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/normalize.min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/pure-min.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css?v=0.0.0"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="/js/jquery.min.js?v=0.0.0"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">记一次数据迁移的经历</h1><a id="logo" href="/.">Swinepig</a><p class="description">情流感的博格</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">记一次数据迁移的经历</h1><div class="post-meta">Aug 28, 2016<span> | </span><span class="category"><a href="/categories/database/">database</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#具体详细步骤"><span class="toc-number">1.</span> <span class="toc-text">具体详细步骤</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#源数据源数据导出"><span class="toc-number">1.1.</span> <span class="toc-text">源数据源数据导出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#碰到的问题"><span class="toc-number">2.</span> <span class="toc-text">碰到的问题</span></a></li></ol></div></div><div class="post-content"><p>前段时间公司要求我们项目版本做一次回收，因需要回公司做演示还需要将服务器数据考回到本地–这步比较棘手因为客户方开发环境U盘无法使用=。=，最后好不容易找了个借口<br>向别人搞了个内部U盘。</p>
<p>我们开发环境为AIX+DB2，因为只需做演示使用数据导出觉定不采用 <code>db2move</code> 命令，只选取全部基础表+少量业务表做数据导出(使用 <code>export</code> 命令)</p>
<p>总的来说按照以下步骤进行：</p>
<ul>
<li>源数据源数据导出(export)</li>
<li>源数据库表结构等导出(db2look)</li>
<li>本地Win环境安装DB2，重建数据库(缓冲区，表空间，索引空间等)</li>
<li>本地数据结构恢复(db2 -tf db2look.sql)</li>
<li>本地数据恢复(import)</li>
</ul>
<h2 id="具体详细步骤"><a href="#具体详细步骤" class="headerlink" title="具体详细步骤"></a>具体详细步骤</h2><h3 id="源数据源数据导出"><a href="#源数据源数据导出" class="headerlink" title="源数据源数据导出"></a>源数据源数据导出</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">db2 connect <span class="keyword">to</span> dbname</div><div class="line">db2 -<span class="keyword">tf</span> exportDate.sql</div></pre></td></tr></table></figure>
<p>exportData.sql中类似 <code>export to XX.del OF DEL SELECT * FROM XX</code> 语句</p>
<p><strong>源数据库表结构等导出</strong> </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">db2look -d DBname -<span class="selector-tag">a</span> -e -<span class="selector-tag">p</span> -<span class="selector-tag">i</span> userID -w password -o db2look.sql</div></pre></td></tr></table></figure>
<p> <strong>重建数据库</strong> </p>
<figure class="highlight oxygene"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> DATABASE DBNAME AUTOMATIC STORAGE NO  <span class="keyword">ON</span> <span class="string">'G:\'</span> <span class="keyword">USING</span> CODESET GBK TERRITORY CN COLLATE <span class="keyword">USING</span> SYSTEM PAGESIZE <span class="number">32768</span> </div><div class="line">    </div><div class="line"><span class="keyword">CREATE</span> BUFFERPOOL CSBP1 IMMEDIATE  SIZE <span class="number">4000</span> PAGESIZE <span class="number">32</span> K </div><div class="line">   </div><div class="line"><span class="keyword">CREATE</span> REGULAR TABLESPACE CS_DATA PAGESIZE <span class="number">32</span> K MANAGED <span class="keyword">BY</span> DATABASE <span class="keyword">USING</span> ( FILE <span class="string">'G:\TBS\tablespace'</span> <span class="number">65536</span> ) EXTENTSIZE <span class="number">32</span> OVERHEAD <span class="number">10.5</span> PREFETCHSIZE <span class="number">32</span> TRANSFERRATE <span class="number">0.14</span> BUFFERPOOL  CSBP1</div><div class="line">   </div><div class="line"></div><div class="line"><span class="keyword">CREATE</span> REGULAR TABLESPACE CS_IDX PAGESIZE <span class="number">32</span> K MANAGED <span class="keyword">BY</span> DATABASE <span class="keyword">USING</span> ( FILE <span class="string">'G:\TBS\indexspace'</span> <span class="number">1310720</span> ) EXTENTSIZE <span class="number">32</span> OVERHEAD <span class="number">10.5</span> PREFETCHSIZE <span class="number">32</span> TRANSFERRATE <span class="number">0.14</span> BUFFERPOOL  CSBP1</div><div class="line">  </div><div class="line"></div><div class="line">GRANTDBADM,CREATETAB,BINDADD,CONNECT,CREATE_NOT_FENCED_ROUTINE,IMPLICIT_SCHEMA,LOAD,CREATE_EXTERNAL_ROUTINE,QUIESCE_CONNECT,SECADM <span class="keyword">ON</span> DATABASE <span class="keyword">TO</span> USER userID</div><div class="line">   </div><div class="line"></div><div class="line">GRANT USE <span class="keyword">OF</span> TABLESPACE CS_DATA <span class="keyword">TO</span> USER ccmsdb <span class="keyword">WITH</span> GRANT OPTION</div></pre></td></tr></table></figure>
<p><strong>本地数据结构恢复</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">db2</span> <span class="selector-tag">-tvf</span> <span class="selector-tag">db2look</span><span class="selector-class">.sql</span></div></pre></td></tr></table></figure>
<p><strong>本地数据恢复</strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">db2</span> <span class="selector-tag">-tf</span> <span class="selector-tag">importDate</span><span class="selector-class">.sql</span></div></pre></td></tr></table></figure>
<p>importDate.sql中类似 <code>import from  XX.del OF DEL replace into XX</code> 语句</p>
<blockquote>
<p><strong>Note:</strong><br>   对于主键自增长型 GENERATED ALWAYS AS IDENTIFY 和 GENERATED BY DEFAULT AS IDENTIFY 数据重新导入时为了不影响原来的自增主键需使用<br>   <code>load from XX.del of del modified by identityoverride replace into basi_role nonrecoverable</code></p>
</blockquote>
<h2 id="碰到的问题"><a href="#碰到的问题" class="headerlink" title="碰到的问题"></a>碰到的问题</h2><p>现象：数据库安装好后，需安装应用服务器WEBLOGIC,在应用部署到WEBLOGIC上后出现 <code>org.hibernate.QueryException: ClassNotFoundException: org.hibernate.hql.ast.HqlToken</code> 异常</p>
<p>原因：Hibernate3 采用新的基于 antlr 的 HQL/SQL 查询翻译器，在 hibernate3 中需要用到 antlr，然而这个包在 weblogic 中已经包含了 antrl 类库，所以会产生一些类加载的错误，无法找到在 war 或 ear 中的 hibernate3.jar</p>
<p>解决方案：修改 %DOMAIN_HOME%/bin/setDomainEnv.cmd（Linux 为 setDomainEnv.sh），如：D:\Program\weblogic-10.3.6\mydomain\bin\setDomainEnv.cmd，在 set JAVA_HOME 的后面加上set PRE_CLASSPATH=path_of_antlr_jar</p>
<hr>
<p>现象：不知什么原因在配置DB2数据源选择IBM DB2 TYPE4驱动时填写IP和端口时页面没有此两项输入地方，后台又提示必须输入主机和端口。</p>
<p>原因：未知，删除缓存重启WEBLOGIC也不行</p>
<p>解决方案：采用一个投机取巧的办法：先将安装DB2时安装的DB2驱动放到WEBLOGIC域下lib下面，然后在WEBLOGIC建数据源时选取ORACLE DB2驱动(选择这个无法连接数据库可能还需要原厂商的好使)，<br>然后手动修改IBM DB2的url和驱动类(com.ibm.db2.jcc.DB2Driver)</p>
<hr>
<p>现象：应用在本地出现未知错误</p>
<p>原因：查看日志发现存在很多java.lang.OutOfMemoryError: PermGen space，内存溢出。使用jvisualvm发现持久代MaxPermSize值只有128MB</p>
<p>解决方案：%DOMAIN_HOME%/bin/setDomainEnv.cmd（Linux 为 setDomainEnv.sh）-Xms1024m -Xmx1024m -XX:PermSize=48m -XX:MaxPermSize=256m </p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="http://yoursite.com/2016/08/28/db2datatransfer/" data-id="cisljson30002glshzz8uapph" class="article-share-link">分享到</a><div class="tags"><a href="/tags/db2/">db2</a></div><div class="post-nav"><a href="/2016/09/02/My-New-Post/" class="pre">My New Post</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Swinepig.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="http://www.miitbeian.gov.cn/"> 浙ICP备16030196号</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>